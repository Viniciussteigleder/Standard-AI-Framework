// =============================================================================
// PRISMA SCHEMA - Standard AI Framework
// =============================================================================
// 
// This schema defines the database structure for AI-powered applications.
// Run `pnpm db:generate` to generate the Prisma Client.
// Run `pnpm db:migrate` to apply migrations.
// Run `pnpm db:seed` to seed development data.
//
// =============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector"), uuid_ossp(map: "uuid-ossp")]
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserRole {
  ADMIN
  MEMBER
  VIEWER
  GUEST
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  TOOL
}

enum WorkflowStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum IntegrationType {
  GOOGLE_SHEETS
  GOOGLE_DRIVE
  GITHUB
  SLACK
  N8N
  AWS_S3
  WEBHOOK
}

// =============================================================================
// USER & AUTHENTICATION
// =============================================================================

model User {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String     @unique
  name          String?
  avatarUrl     String?    @map("avatar_url")
  passwordHash  String?    @map("password_hash")
  role          UserRole   @default(MEMBER)
  status        UserStatus @default(ACTIVE)
  
  // Multi-tenancy
  tenantId      String?    @map("tenant_id") @db.Uuid
  tenant        Tenant?    @relation(fields: [tenantId], references: [id])
  
  // OAuth
  emailVerified DateTime?  @map("email_verified")
  
  // Metadata
  preferences   Json?      @default("{}")
  metadata      Json?      @default("{}")
  
  // Timestamps
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  lastLoginAt   DateTime?  @map("last_login_at")
  deletedAt     DateTime?  @map("deleted_at")
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  conversations Conversation[]
  apiKeys       ApiKey[]
  
  @@map("users")
}

model Account {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String  @map("user_id") @db.Uuid
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refreshToken      String? @map("refresh_token") @db.Text
  accessToken       String? @map("access_token") @db.Text
  expiresAt         Int?    @map("expires_at")
  tokenType         String? @map("token_type")
  scope             String?
  idToken           String? @map("id_token") @db.Text
  sessionState      String? @map("session_state")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Uuid
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
  @@map("verification_tokens")
}

model ApiKey {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  name        String
  keyHash     String    @unique @map("key_hash")
  keyPrefix   String    @map("key_prefix") // First 8 chars for identification
  scopes      String[]  @default([])
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  
  createdAt   DateTime  @default(now()) @map("created_at")
  revokedAt   DateTime? @map("revoked_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("api_keys")
}

// =============================================================================
// MULTI-TENANCY
// =============================================================================

model Tenant {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String   @unique
  plan        String   @default("free")
  settings    Json?    @default("{}")
  metadata    Json?    @default("{}")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  users       User[]
  agents      Agent[]
  workflows   Workflow[]
  integrations Integration[]
  
  @@map("tenants")
}

// =============================================================================
// AI AGENTS
// =============================================================================

model Agent {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String?  @map("tenant_id") @db.Uuid
  
  name          String
  slug          String
  description   String?
  systemPrompt  String   @map("system_prompt") @db.Text
  
  // Model configuration
  provider      String   @default("anthropic")
  model         String   @default("claude-3-5-sonnet-20241022")
  temperature   Float    @default(0.7)
  maxTokens     Int?     @map("max_tokens")
  
  // Tools & capabilities
  tools         String[] @default([])
  skills        String[] @default([])
  
  // Memory configuration
  memoryType    String   @default("buffer") @map("memory_type")
  maxMessages   Int      @default(50) @map("max_messages")
  
  // Settings
  isPublic      Boolean  @default(false) @map("is_public")
  isActive      Boolean  @default(true) @map("is_active")
  metadata      Json?    @default("{}")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  tenant        Tenant?  @relation(fields: [tenantId], references: [id])
  conversations Conversation[]
  
  @@unique([tenantId, slug])
  @@map("agents")
}

// =============================================================================
// CONVERSATIONS & MESSAGES
// =============================================================================

model Conversation {
  id          String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String             @map("user_id") @db.Uuid
  agentId     String             @map("agent_id") @db.Uuid
  
  title       String?
  status      ConversationStatus @default(ACTIVE)
  metadata    Json?              @default("{}")
  
  // Token tracking
  totalInputTokens  Int @default(0) @map("total_input_tokens")
  totalOutputTokens Int @default(0) @map("total_output_tokens")
  
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  
  // Relations
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent       Agent              @relation(fields: [agentId], references: [id])
  messages    Message[]
  
  @@index([userId, createdAt])
  @@index([agentId])
  @@map("conversations")
}

model Message {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversationId  String      @map("conversation_id") @db.Uuid
  
  role            MessageRole
  content         String      @db.Text
  
  // Tool calls
  toolCalls       Json?       @map("tool_calls")
  toolCallId      String?     @map("tool_call_id")
  
  // Metrics
  inputTokens     Int?        @map("input_tokens")
  outputTokens    Int?        @map("output_tokens")
  latencyMs       Int?        @map("latency_ms")
  
  // Model info
  model           String?
  
  metadata        Json?       @default("{}")
  createdAt       DateTime    @default(now()) @map("created_at")
  
  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId, createdAt])
  @@map("messages")
}

// =============================================================================
// VECTOR STORAGE (RAG)
// =============================================================================

model Document {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String?  @map("tenant_id") @db.Uuid
  
  title       String
  content     String   @db.Text
  contentHash String   @map("content_hash")
  
  // Source tracking
  source      String?
  sourceId    String?  @map("source_id")
  sourceUrl   String?  @map("source_url")
  
  // Chunking
  chunkIndex  Int      @default(0) @map("chunk_index")
  chunkTotal  Int      @default(1) @map("chunk_total")
  parentId    String?  @map("parent_id") @db.Uuid
  
  metadata    Json?    @default("{}")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  embeddings  Embedding[]
  
  @@unique([contentHash, chunkIndex])
  @@index([tenantId])
  @@map("documents")
}

model Embedding {
  id          String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentId  String                      @map("document_id") @db.Uuid
  
  // Vector embedding (using pgvector)
  embedding   Unsupported("vector(1536)")
  
  // Model info
  model       String                      @default("text-embedding-3-small")
  
  createdAt   DateTime                    @default(now()) @map("created_at")
  
  // Relations
  document    Document                    @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  @@index([documentId])
  @@map("embeddings")
}

// =============================================================================
// WORKFLOWS
// =============================================================================

model Workflow {
  id          String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String?        @map("tenant_id") @db.Uuid
  
  name        String
  description String?
  
  // Trigger configuration
  triggerType String         @map("trigger_type")
  triggerConfig Json?        @map("trigger_config")
  
  // Steps (JSON array of WorkflowStep)
  steps       Json           @default("[]")
  
  status      WorkflowStatus @default(DRAFT)
  metadata    Json?          @default("{}")
  
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  
  // Relations
  tenant      Tenant?        @relation(fields: [tenantId], references: [id])
  executions  WorkflowExecution[]
  
  @@index([tenantId])
  @@map("workflows")
}

model WorkflowExecution {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workflowId  String          @map("workflow_id") @db.Uuid
  
  status      ExecutionStatus @default(PENDING)
  
  // Input/Output
  input       Json?
  output      Json?
  
  // Step executions
  stepResults Json?           @map("step_results") @default("[]")
  
  // Tracking
  startedAt   DateTime        @default(now()) @map("started_at")
  completedAt DateTime?       @map("completed_at")
  
  error       String?
  metadata    Json?           @default("{}")
  
  // Relations
  workflow    Workflow        @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  @@index([workflowId, startedAt])
  @@map("workflow_executions")
}

// =============================================================================
// INTEGRATIONS
// =============================================================================

model Integration {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String?         @map("tenant_id") @db.Uuid
  
  type        IntegrationType
  name        String
  
  // Encrypted credentials
  credentials Json?           @default("{}")
  settings    Json?           @default("{}")
  
  isEnabled   Boolean         @default(true) @map("is_enabled")
  
  // Status tracking
  lastSyncAt  DateTime?       @map("last_sync_at")
  lastError   String?         @map("last_error")
  
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  
  // Relations
  tenant      Tenant?         @relation(fields: [tenantId], references: [id])
  
  @@unique([tenantId, type, name])
  @@map("integrations")
}

// =============================================================================
// AUDIT LOG
// =============================================================================

model AuditLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  
  action      String
  resourceType String  @map("resource_type")
  resourceId  String?  @map("resource_id")
  
  userId      String?  @map("user_id") @db.Uuid
  tenantId    String?  @map("tenant_id") @db.Uuid
  
  outcome     String   // success, failure
  
  // Request context
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  
  // Details
  details     Json?    @default("{}")
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([userId, createdAt])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}
